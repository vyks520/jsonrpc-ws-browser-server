var jsonrpcWsBrowserServer=function(r){"use strict";function e(r,e,t,n){return new(t||(t=Promise))((function(s,o){function i(r){try{a(n.next(r))}catch(r){o(r)}}function c(r){try{a(n.throw(r))}catch(r){o(r)}}function a(r){var e;r.done?s(r.value):(e=r.value,e instanceof t?e:new t((function(r){r(e)}))).then(i,c)}a((n=n.apply(r,e||[])).next())}))}function t(r){return new Promise((e=>{setTimeout(e,r)}))}function n(r,e){if(c("object"==typeof r,"not an object or array"),Array.isArray(r))return r;{const t=e.map((()=>{}));for(const n of Object.keys(r)){const s=e.indexOf(n);c(-1!==s,`unknown param: ${n}`),t[s]=r[n]}return t}}"function"==typeof SuppressedError&&SuppressedError;const s=/(\/\/.*$)|(\/\*[\s\S]*?\*\/)|(\s*=[^,\)]*(('(?:\\'|[^'\r\n])*')|("(?:\\"|[^"\r\n])*"))|(\s*=[^,\)]*))/gm,o=/([^\s,]+)/g;function i(r){const e=r.toString().replace(s,"");return e.slice(e.indexOf("(")+1,e.indexOf(")")).match(o)||[]}function c(r,e){if(!r)throw e}var a,l=Object.freeze({__proto__:null,assert:c,getParamNames:i,resolveParams:n,sleep:t});function d(r){return null!==r.id&&void 0!==r.id||void 0!==r.error}r.JsonRpcErrorCode=void 0,(a=r.JsonRpcErrorCode||(r.JsonRpcErrorCode={}))[a.ParseError=-32700]="ParseError",a[a.InvalidRequest=-32600]="InvalidRequest",a[a.MethodNotFound=-32601]="MethodNotFound",a[a.InvalidParams=-32602]="InvalidParams",a[a.InternalError=-32603]="InternalError";class u{constructor(r,e){this.name="JSONRPCError",this.code=r,this.message=e||r}info(){return`${this.name}: ${this.message}`}}class h{constructor({error:e,request:t,result:n}){this.jsonrpc="2.0",n&&e||(this.error=new u(r.JsonRpcErrorCode.InvalidRequest,"must specify either result or error")),n&&e||(this.error=new u(r.JsonRpcErrorCode.InvalidRequest,"result and error are mutually exclusive")),this.id=t?t.id:null,this.error=e,this.request=t,this.result=void 0===n?null:n}toJSON(){const{jsonrpc:r,id:e,error:t,result:n}=this;return t?{jsonrpc:r,id:e,error:t}:{jsonrpc:r,id:e,result:n}}stringify(){return JSON.stringify(this.toJSON())}}class p{static from(r){const{jsonrpc:e,method:t,params:n,id:s}=r;return new p(e,s,t,n)}constructor(r,e,t,n){this.jsonrpc=r,this.id=e,this.method=t,this.params=n,c("2.0"===r,"invalid rpc version"),c(function(r){return null==r||"string"==typeof r||"number"==typeof r&&Number.isSafeInteger(r)}(e),"invalid id"),c("string"==typeof t,"invalid method")}}function f(r,e){if(!r)throw new u(400,e||"Assertion failed")}function v(r,e,t){if(r!=e)throw new u(400,`${t||"Assertion failed"}`)}return r.JsonRpcError=u,r.JsonRpcRequest=p,r.JsonRpcResponse=h,r.JsonRpcServer=class{constructor(t,s){this.url=t,this.namespace=s,this.methods={},this.ws=null,this.closed=!1,this.onopen=null,this.onerror=null,this.handleWsMessage=t=>e(this,void 0,void 0,(function*(){let e;try{e=JSON.parse(t)}catch(e){const t=new u(r.JsonRpcErrorCode.ParseError,"Parse error, request data parsing failed"),n=new h({error:t});return this.send(n.stringify()),void console.error(t.info())}if(Array.isArray(e)&&0===e.length){const e=new u(r.JsonRpcErrorCode.InvalidRequest,"Invalid Request"),t=new h({error:e});return this.send(t),void console.error(e.info())}if(Array.isArray(e)){const r=e.map((r=>this.handleRequest(r))),t=(yield Promise.all(r)).filter(d);this.send(t)}else{const r=yield this.handleRequest(e);this.send(d(r)?r:"")}})),this.handleRequest=t=>e(this,void 0,void 0,(function*(){let e;try{e=p.from(t)}catch(e){const n=new u(r.JsonRpcErrorCode.InvalidRequest,`${e}, Invalid Request`);return new h({request:{id:(null==t?void 0:t.id)||null},error:n})}const s=this.methods[e.method];if(!s){const t=new u(r.JsonRpcErrorCode.MethodNotFound,"Method not found");return new h({request:e,error:t})}let o,i;try{o=void 0!==e.params?n(e.params,s.params):[]}catch(t){const n=new u(r.JsonRpcErrorCode.InvalidParams,`${t}, Invalid params`);return new h({request:e,error:n})}try{const r={assert:f,assertEqual:v,request:e};i=yield s.method.apply(r,o)}catch(t){return t instanceof u||(t=new u(r.JsonRpcErrorCode.InternalError,`${t}, Internal error`)),new h({request:e,error:t})}return new h({request:e,result:i})}))}register(r,e){const t=this.namespace?`${this.namespace}.${r}`:r;if(this.methods[t])return"json rpc server method already exists";const n=i(e);return this.methods[t]={method:e,params:n},null}close(){this.closed=!0,this.ws&&this.ws.close()}open(){const n=()=>new Promise(((t,n)=>{this.closed=!1;try{const s=new WebSocket(this.url);this.ws=s,s.onopen=()=>{var r;null===(r=this.onopen)||void 0===r||r.call(this),t()},s.onerror=()=>{var e;const t=new u(r.JsonRpcErrorCode.InternalError,`connection to '${this.url}' failed`).info();null===(e=this.onerror)||void 0===e||e.call(this,t),n(t)},s.onclose=function(r){},s.onmessage=r=>e(this,void 0,void 0,(function*(){yield this.handleWsMessage(r.data)}))}catch(e){n(new u(r.JsonRpcErrorCode.InternalError,e))}})),s=r=>e(this,void 0,void 0,(function*(){var e;let n=10;for(let s=0;;){if(n=s<=10?5e3:6e4,yield t(n),this.closed)return;this.ws&&3!==this.ws.readyState||(3===(null===(e=null==this?void 0:this.ws)||void 0===e?void 0:e.readyState)&&this.ws.close(),console.warn("jsonRpcServer: WebSocket reconnect"),yield r().then((()=>{s=0,n=5e3})).catch((r=>{console.error(r)})),s<=10&&s++)}}));return new Promise(((r,t)=>e(this,void 0,void 0,(function*(){yield n().then((()=>{r(null)})).catch((r=>{t(r)})),s(n).then()}))))}send(e){if(!this.ws)return new u(r.JsonRpcErrorCode.InternalError,"service is not open").info();let t;t=e&&"object"==typeof e?e.stringify?e.stringify():JSON.stringify(e):e;try{this.ws.send(t)}catch(e){console.error(new u(r.JsonRpcErrorCode.InternalError,e).info())}}},r.rpcAssert=f,r.rpcAssertEqual=v,r.utils=l,r}({});
